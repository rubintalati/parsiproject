<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sudreh Kusti Ritual - The Parsi Project</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Manrope', sans-serif;
            background-color: #000;
            color: #fff;
            min-height: 100vh;
            padding: 2rem 1rem;
            /* Custom scrollbar styling */
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.18;
            background-image: url('data:image/svg+xml;utf8,<svg width="100%25" height="100%25" xmlns="http://www.w3.org/2000/svg"><filter id="noiseFilter"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="4" stitchTiles="stitch"/></filter><rect width="100%25" height="100%25" filter="url(%23noiseFilter)"/></svg>');
        }

        /* Custom scrollbar for Webkit browsers (Chrome, Safari, etc.) */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        /* Hide scrollbar when not in use */
        ::-webkit-scrollbar-thumb:vertical {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        body:hover::-webkit-scrollbar-thumb:vertical,
        body:active::-webkit-scrollbar-thumb:vertical {
            opacity: 1;
        }

        .container {
            max-width: 650px;
            margin: 0 auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(0, 0, 0, 0.5);
            overflow: hidden;
            padding-left: 1.2rem;
            padding-right: 1.2rem;
            position: relative;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .back-button {
            color: #fff;
            text-decoration: none;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }

        .back-button:hover {
            color: #ccc;
        }

        .back-arrow {
            margin-right: 0.5rem;
        }

        .prayer-header {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 2rem;
            padding: 2rem 0 0 0;
        }

        .prayer-title {
            font-size: 2rem;
            margin-bottom: 1rem;
            font-weight: bold;
        }

        .prayer-subtitle {
            color: #999;
            margin-bottom: 0rem;
            font-size: 1.1rem;
            line-height: 1.1;
        }

        .prayer-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 0.1rem;
            margin-bottom: 1rem;
            line-height: 1.1;
        }

        .prayer-text {
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .prayer-translation {
            margin-top: 2rem;
            margin-bottom: 2rem;
            color: #ccc;
            line-height: 1.6;
            padding-left: 1rem;
            border-left: 2px solid rgba(255, 255, 255, 0.2);
        }

        .prayer-section {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Top section GIF layout - 2x2 grid */
        .gif-grid-top {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .gif-box {
            background-color: rgba(40, 40, 40, 0.5);
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 8px;
        }

        .gif-box video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Middle section GIF - single box */
        .gif-single {
            margin-bottom: 2rem;
        }
        
        .gif-single .gif-box {
            width: 100%;
            aspect-ratio: 16/4;
            height: 120px;
        }
        
        /* Bottom section GIF layout */
        .gif-grid-bottom {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        /* Final GIF - single box */
        .gif-final {
            margin-bottom: 2rem;
        }
        
        .gif-final .gif-box {
            width: 100%;
            aspect-ratio: 16/4;
            height: 120px;
        }

        .compass-container {
            position: absolute;
            top: 2rem;
            right: 2rem;
            width: 120px;
            height: 120px;
            z-index: 10;
        }
        .compass {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .compass-ring {
            position: absolute;
            width: 70%;
            height: 70%;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1;
        }
        .compass-needle {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transform-origin: center center;
            transition: transform 0.3s ease;
        }
        .compass-needle svg {
            width: 75%;
            height: 75%;
        }
        .compass-direction {
            position: absolute;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            opacity: 0.75;
            pointer-events: none;
            z-index: 2;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .compass-direction.active {
            opacity: 1;
            color: white;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.8), 0 0 10px rgba(255, 255, 255, 0.5);
            font-weight: 700;
            background-color: rgba(30, 30, 30, 0.8);
        }
        .compass-direction.north {
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
        }
        .compass-direction.east {
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
        }
        .compass-direction.south {
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
        }
        .compass-direction.west {
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
        }
        @media (max-width: 768px) {
            .compass-container {
                top: 1.5rem;
                right: 1.5rem;
                width: 100px;
                height: 100px;
            }
            .compass-direction {
                font-size: 14px;
                width: 20px;
                height: 20px;
            }
            .compass-direction.north {
                top: 10px;
            }
            .compass-direction.east {
                right: 10px;
            }
            .compass-direction.south {
                bottom: 10px;
            }
            .compass-direction.west {
                left: 10px;
            }
        }
        .direction-advice {
            font-size: 13px;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 12px;
            margin-left: 0;
            margin-right: auto;
            letter-spacing: 0.2px;
            background-color: rgba(255,255,255,0.13);
            color: #fff;
            border-radius: 3px;
            padding: 2px 10px;
            box-shadow: 0 1px 6px 0 rgba(0,0,0,0.10);
            display: inline-block;
            text-align: left;
            min-width: 0;
            width: auto;
            max-width: 100vw;
        }
        @media (max-width: 768px) {
            .direction-advice {
                margin-left: 0;
                margin-bottom: 10px;
            }
        }
        @media (max-width: 768px) {
            .container {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            .prayer-title {
                font-size: 1.5rem;
            }
            
            .prayer-subtitle {
                font-size: 1rem;
            }
            
            .prayer-name {
                font-size: 1.3rem;
            }
        }
        @media (max-width: 768px) {
            .prayer-header {
                padding: 1.2rem 0 0 0;
            }
        }

        .compass-container {
            margin: 2rem auto;
            width: 200px;
            position: relative;
            text-align: center;
        }

        .compass {
            width: 200px;
            height: 200px;
            position: relative;
            margin: 0 auto;
        }

        .compass-ring {
            width: 100%;
            height: 100%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
        }

        .compass-needle {
            width: 90%;
            height: 90%;
            position: absolute;
            top: 5%;
            left: 5%;
            transition: transform 0.3s ease-out;
        }

        .compass-direction {
            position: absolute;
            font-size: 14px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.6);
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 20px;
            transition: color 0.3s;
        }

        .north {
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
        }

        .east {
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }

        .south {
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
        }

        .west {
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
        }

        .compass-direction.active {
            color: #fff;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        .permission-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            padding: 8px 16px;
            display: none;
            z-index: 1000;
        }

        .compass-status {
            text-align: center;
            font-size: 0.8rem;
            margin-top: 0.5rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .accuracy-high {
            color: #4CAF50;
        }

        .accuracy-medium {
            color: #FFC107;
        }

        .accuracy-low {
            color: #FF9800;
        }

        .accuracy-unreliable,
        .accuracy-error {
            color: #F44336;
        }

        .accuracy-calibrating {
            color: #2196F3;
            animation: blink 1s infinite;
        }

        .compass-button {
            display: block;
            margin: 0.5rem auto;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="compass-container">
            <div class="compass">
                <div class="compass-ring"></div>
                <div class="compass-needle" id="compass-needle">
                    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="50" cy="50" r="40" fill="none" stroke="#fff" stroke-width="1"/>
                        <path d="M50 10 L65 50 L50 90 L35 50 Z" fill="rgba(255,255,255,0.7)"/>
                        <circle cx="50" cy="50" r="8" fill="#000" stroke="#fff" stroke-width="1.5"/>
                    </svg>
                </div>
                <div class="compass-direction north" data-direction="north" data-min="315" data-max="45">N</div>
                <div class="compass-direction east" data-direction="east" data-min="45" data-max="135">E</div>
                <div class="compass-direction south" data-direction="south" data-min="135" data-max="225">S</div>
                <div class="compass-direction west" data-direction="west" data-min="225" data-max="315">W</div>
            </div>
            <div class="compass-status">Waiting for compass...</div>
            <button id="calibrate-button" class="compass-button">Calibrate Compass</button>
        </div>
        <button id="permission-button" class="permission-button">Enable Compass</button>
        <div style="height:12px;"></div>
        <div class="header">
            <a href="../home.html" class="back-button">
                <span class="back-arrow">←</span>
            </a>
        </div>
        
        <div class="prayer-header">
            <div id="direction-advice" class="direction-advice"></div>
            <h1 class="prayer-title">sudreh kasti ritual</h1>
            <p class="prayer-subtitle">Khshnaothra ahunahe mazdāo, Ashem Vohū 1</p>
        </div>

        <!-- Top GIF section - 2 videos side by side -->
        <div class="gif-grid-top">
            <div class="gif-box">
                <video autoplay loop muted playsinline>
                    <source src="../../media/gifs/sudrehkasti1.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
            <div class="gif-box">
                <video autoplay loop muted playsinline>
                    <source src="../../media/gifs/sudrehkasti2.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
        </div>
        
        <!-- Kem-nā-mazdā Section -->
        <div class="prayer-section" style="margin-top: 0; padding-top: 0; border-top: none;">
            <p class="prayer-subtitle">the one for divine protection</p>
            <h2 class="prayer-name">kem-nā-mazdā</h2>
            
            <div class="prayer-text">
                <p>Kem-nā Mazdā, mavaitē pāyūm dadāt, hyat mā dregvāo didareshatā aēnanghē, anyem thwahmat āthraschā mananghaschā, yayāo shyaothanāish ashem thraoshtā Ahurā, tām mōi dąstvām daēnayāi frāvaocā.</p>
            </div>
            
            <div class="prayer-translation">
                <p>Ahura Mazda, who will protect me from all evil, but Thyself? Show me a spiritual guide, who with the aid of Good Mind will protect me from evil. May the wicked be destroyed and may the evil one demolish Your Creation. I create Good thoughts and prosperity. I respect and honour.</p>
            </div>
        </div>
        
        <!-- Middle GIF section - single horizontal box -->
        <div class="gif-single">
            <div class="gif-box">
                <video autoplay loop muted playsinline>
                    <source src="../../media/gifs/sudrehkasti6.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
        </div>
        
        <!-- Hormazd Khodāy Section -->
        <div class="prayer-section">
            <p class="prayer-subtitle">the one for forgiveness</p>
            <h2 class="prayer-name">hormazd khodāy</h2>
            
            <div class="prayer-text">
                <p>Hormazd Khodāy ahereman awādashān dūr-awāzāyashnē, zad-shikashtē bād. Ahereman dēwān drūjān awādashān, gunāhgārān dūsh-manashān, dush-gūftārān, dush-kunashān, drūjān, druzān, jādūgārān, grimānigān karino-gān tā-sar-nigūn bād, shikashtē bād.</p>
                <br>
                <p>Dushmananshān awazdashān bād, dushmanashān awazdashān bād.</p>
                <br>
                <p>Hormazd Khodāy aż hamā gunāh patet pashēmānum. Az harche gunāh wanāh, kerdarē kuneshnē, minishnē kunishnē, bunē gunāh, robnē gunāh, az geti minoi, ōhē awakhsh pashēmānum, pa sē garznē patet hom.</p>
                <br>
                <p>Khshnaothra ahunahe mazdāo, tarōidite angrahe mainyēush. Haithy-āvarshtām hyat vasnā frashōtemem. Staomi ashem. Ashem Vohū 1.</p>
            </div>
            
            <div class="prayer-translation">
                <p>May Dadar Hormazd, Who is the Lord of the Universe, destroy all evil. I ask forgiveness for all sins of thought, word or deed. O Dadar Hormazd, I promise to please Thee by adopting all will and by following this path of righteousness which will bring happiness in the world.</p>
            </div>
        </div>
        
        <!-- Bottom GIF section - 2x2 grid -->
        <div class="gif-grid-bottom">
            <div class="gif-box">
                <video autoplay loop muted playsinline>
                    <source src="../../media/gifs/sudrehkasti6.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
            <div class="gif-box"></div>
        </div>
        
        <!-- Jasa me avanghe Mazda Section -->
        <div class="prayer-section">
            <p class="prayer-subtitle">the one for faithful devotion</p>
            <h2 class="prayer-name">jasa me avanghe mazda</h2>
            
            <div class="prayer-text">
                <p>Jasa me avanghe Mazda (3). Mazdayasnō ahmī, mazdayasnō zarathushtrish. Fravarānē astūtō būtōish astūtō būtōish. Astuye humatem manō, astuye hūkhtem vachō, astuye hvarshtem shyaothnem. Astuye daēnām vanghuhīm māzdayasnīm, fraspāyaokhēdrām, nidhāsnaithrishem, khraozhdishem, khraozhdish-tōishem. Yasnāicha vahmāicha khshnaothrāicha frasastayaecha, yā hāitīm vīspāish ashem stūtōish stūtōish. Aētat dīsh āyesē yesne, haithyāvarshtām hyat vasnā frashōtemen. Staomi ashem. Ashem Vohū 1.</p>
            </div>
            
            <div class="prayer-translation">
                <p>I ask for divine help and proclaim that I belong to the Mazdayasnan religion and have full faith in it only. My religion teaches me to be good in thought, word and deed and firmly I believe that all good things come from Ahura Mazda.</p>
            </div>
        </div>
        
        <!-- Final GIF - single horizontal box -->
        <div class="gif-final">
            <div class="gif-box">
                <video autoplay loop muted playsinline>
                    <source src="../../media/gifs/sudrehkusti10.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // IMPROVED COMPASS FUNCTIONALITY
            initCompass();
            
            // Rest of the functions for menu navigation
            var sidebar = document.getElementById("sidebar");
            var menuToggle = document.getElementById("menu-toggle");

            menuToggle.addEventListener("click", function() {
                sidebar.classList.toggle("sidebar-open");
                menuToggle.classList.toggle("menu-active");
            });

            // Close sidebar when clicking outside
            document.addEventListener("click", function(event) {
                if (!sidebar.contains(event.target) && !menuToggle.contains(event.target) && sidebar.classList.contains("sidebar-open")) {
                    sidebar.classList.remove("sidebar-open");
                    menuToggle.classList.remove("menu-active");
                }
            });
        });
        
        // Improved compass implementation
        function initCompass() {
            const compassNeedle = document.getElementById('compass-needle');
            const permissionButton = document.getElementById('permission-button');
            const calibrateButton = document.getElementById('calibrate-button');
            const compassStatus = document.querySelector('.compass-status');
            const directions = document.querySelectorAll('.compass-direction');
            
            // Track if we have a reliable compass reading
            let hasAccurateReading = false;
            let compassErrorCount = 0;
            
            // Compass accuracy states
            const ACCURACY = {
                HIGH: 'high',
                MEDIUM: 'medium',
                LOW: 'low',
                UNRELIABLE: 'unreliable'
            };
            
            // Variables to track readings
            let lastHeading = 0;
            let alphaFilter = new KalmanFilter();
            let accuracyState = ACCURACY.UNRELIABLE;
            
            // Helper function to get compass accuracy
            function getAccuracyLevel(accuracy) {
                if (accuracy !== undefined) {
                    if (accuracy < 15) return ACCURACY.HIGH;
                    if (accuracy < 30) return ACCURACY.MEDIUM;
                    if (accuracy < 60) return ACCURACY.LOW;
                }
                return ACCURACY.UNRELIABLE;
            }
            
            // Process orientation data with filters
            function processCompassHeading(heading, accuracy) {
                // Apply Kalman filter to smooth heading
                const filteredHeading = alphaFilter.filter(heading);
                
                // Update last heading
                lastHeading = filteredHeading;
                
                // Update accuracy state
                accuracyState = getAccuracyLevel(accuracy);
                updateCompassUI(filteredHeading);
                
                // Track if we have reliable readings
                hasAccurateReading = (accuracyState !== ACCURACY.UNRELIABLE);
                
                // Update UI to reflect accuracy
                compassStatus.textContent = `Accuracy: ${accuracyState}`;
                compassStatus.className = `compass-status accuracy-${accuracyState}`;
                
                return filteredHeading;
            }
            
            // Update compass UI
            function updateCompassUI(heading) {
                // Animate smoothly to new heading
                compassNeedle.style.transition = 'transform 0.3s ease-out';
                compassNeedle.style.transform = `rotate(${360 - heading}deg)`;
                
                // Update direction highlights
                updateDirectionHighlight(heading);
            }
            
            // Update the direction highlighting
            function updateDirectionHighlight(heading) {
                // Normalize bearing to 0-360
                heading = (heading + 360) % 360;
                
                // Determine which direction we're facing
                let newDirection = null;
                
                directions.forEach(dir => {
                    const dirName = dir.dataset.direction;
                    const minAngle = parseInt(dir.dataset.min);
                    const maxAngle = parseInt(dir.dataset.max);
                    
                    // Check if bearing is within this direction's range
                    if (minAngle > maxAngle) {
                        // For North which wraps around (315-45)
                        if (heading >= minAngle || heading < maxAngle) {
                            newDirection = dirName;
                        }
                    } else {
                        // For other directions
                        if (heading >= minAngle && heading < maxAngle) {
                            newDirection = dirName;
                        }
                    }
                });
                
                // Update active direction class
                directions.forEach(dir => {
                    if (dir.dataset.direction === newDirection) {
                        dir.classList.add('active');
                    } else {
                        dir.classList.remove('active');
                    }
                });
            }
            
            // Handle device orientation event
            function handleDeviceOrientation(event) {
                let heading = null;
                let accuracy = undefined;
                
                // iOS-specific compass heading
                if (event.webkitCompassHeading) {
                    heading = event.webkitCompassHeading;
                    accuracy = event.webkitCompassAccuracy;
                } 
                // Standard orientation API
                else if (event.absolute && event.alpha !== null) {
                    heading = 360 - event.alpha;
                }
                
                // Only process valid headings
                if (heading !== null) {
                    processCompassHeading(heading, accuracy);
                } else {
                    compassErrorCount++;
                    if (compassErrorCount > 10) {
                        compassStatus.textContent = "Compass not available";
                        compassStatus.className = 'compass-status accuracy-error';
                    }
                }
            }
            
            // Prompt for permission
            function requestCompassPermission() {
                if (typeof DeviceOrientationEvent !== 'undefined' && 
                    typeof DeviceOrientationEvent.requestPermission === 'function') {
                    
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                window.addEventListener('deviceorientation', handleDeviceOrientation);
                                permissionButton.style.display = 'none';
                            } else {
                                compassStatus.textContent = "Permission denied";
                                compassStatus.className = 'compass-status accuracy-error';
                            }
                        })
                        .catch(console.error);
                } else {
                    // For devices that don't need permission
                    window.addEventListener('deviceorientation', handleDeviceOrientation);
                }
            }
            
            // Calibration function
            function calibrateCompass() {
                compassStatus.textContent = "Calibrating... rotate device in figure-8 pattern";
                compassStatus.className = 'compass-status accuracy-calibrating';
                
                // Reset the filter
                alphaFilter = new KalmanFilter();
                
                // After calibration time
                setTimeout(() => {
                    compassStatus.textContent = "Calibration complete";
                    setTimeout(() => {
                        if (lastHeading) {
                            updateCompassUI(lastHeading);
                        }
                    }, 1000);
                }, 5000);
            }
            
            // Add event listeners
            permissionButton.addEventListener('click', requestCompassPermission);
            calibrateButton.addEventListener('click', calibrateCompass);
            
            // Try to detect if it's a mobile device
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if (isMobile) {
                permissionButton.style.display = 'block';
            } else {
                compassStatus.textContent = "Compass requires mobile device";
                compassStatus.className = 'compass-status accuracy-error';
                
                // Debug function for desktop testing (move mouse to simulate compass)
                function debugWithMouse(e) {
                    const x = e.clientX;
                    const y = e.clientY;
                    
                    // Calculate angle based on mouse position relative to center of screen
                    const centerX = window.innerWidth / 2;
                    const centerY = window.innerHeight / 2;
                    
                    const angle = Math.atan2(y - centerY, x - centerX) * (180 / Math.PI);
                    const heading = (angle + 90 + 360) % 360; // Convert to compass heading
                    
                    processCompassHeading(heading);
                }
                
                document.addEventListener('mousemove', debugWithMouse);
            }
        }
        
        // Implement Kalman filter for smoother readings
        function KalmanFilter() {
            this.Q = 0.01; // Process noise
            this.R = 0.1;  // Measurement noise
            this.x = 0;    // Initial value
            this.P = 1.0;  // Initial uncertainty
            
            this.filter = function(measurement) {
                // Prediction update
                // x = x
                // P = P + Q
                this.P = this.P + this.Q;
                
                // Measurement update
                const K = this.P / (this.P + this.R);
                
                // Handle the discontinuity between 0 and 360 degrees
                let diff = measurement - this.x;
                if (diff > 180) diff -= 360;
                if (diff < -180) diff += 360;
                
                this.x = (this.x + K * diff) % 360;
                if (this.x < 0) this.x += 360;
                
                this.P = (1 - K) * this.P;
                
                return this.x;
            };
        }
        
        // DIRECTION ADVICE FUNCTIONALITY (SEPARATE)
        function pad2(num) { return num < 10 ? '0'+num : num; }
        function getCurrentTime() { return new Date(); }
        function getSunTimes(cb) {
            const date = new Date();
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const sunTimes = SunCalc.getTimes(date, lat, lng);
                    cb(sunTimes);
                }, error => {
                    const sunTimes = SunCalc.getTimes(date, 40, 0);
                    cb(sunTimes);
                });
            } else {
                const sunTimes = SunCalc.getTimes(date, 40, 0);
                cb(sunTimes);
            }
        }
        function updateDirectionAdvice(sunTimes) {
            const now = getCurrentTime();
            const h = now.getHours();
            const m = now.getMinutes();
            const t = h + m/60;
            const sunrise = sunTimes.sunrise;
            const sunset = sunTimes.sunset;
            const sunriseT = sunrise.getHours() + sunrise.getMinutes()/60;
            const sunsetT = sunset.getHours() + sunset.getMinutes()/60;
            let advice = '';
            if (t >= sunriseT && t < 12.667) {
                advice = 'Face east';
            } else if (t >= 12.667 && t < 15.667) {
                advice = 'Face south or west';
            } else if (t >= 15.667 && t < sunsetT) {
                advice = 'Face west';
            } else if (t >= sunsetT || t < sunriseT) {
                advice = 'Face a lamp/fire/light (not north)';
            }
            document.getElementById('direction-advice').textContent = advice;
        }
        getSunTimes(function(sunTimes) {
            updateDirectionAdvice(sunTimes);
            setInterval(() => updateDirectionAdvice(sunTimes), 60000);
        });
    </script>
</body>
</html>