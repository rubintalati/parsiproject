<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Char-Disha No Namaskar - The Parsi Project</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Manrope', sans-serif;
            background-color: #000;
            color: #fff;
            min-height: 100vh;
            padding: 2rem 1rem;
            /* Custom scrollbar styling */
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.18;
            background-image: url('data:image/svg+xml;utf8,<svg width="100%25" height="100%25" xmlns="http://www.w3.org/2000/svg"><filter id="noiseFilter"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="4" stitchTiles="stitch"/></filter><rect width="100%25" height="100%25" filter="url(%23noiseFilter)"/></svg>');
        }

        /* Custom scrollbar for Webkit browsers (Chrome, Safari, etc.) */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        /* Hide scrollbar when not in use */
        ::-webkit-scrollbar-thumb:vertical {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        body:hover::-webkit-scrollbar-thumb:vertical,
        body:active::-webkit-scrollbar-thumb:vertical {
            opacity: 1;
        }

        .container {
            max-width: 650px;
            margin: 0 auto;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .back-button {
            color: #fff;
            text-decoration: none;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }

        .back-button:hover {
            color: #ccc;
        }

        .back-arrow {
            margin-right: 0.5rem;
        }

        .prayer-header {
            margin-bottom: 2rem;
        }

        .prayer-title {
            font-size: 2rem;
            margin-bottom: 1rem;
            font-weight: bold;
        }

        .prayer-subtitle {
            color: #999;
            margin-bottom: 0rem;
            font-size: 1.1rem;
            line-height: 1.1;
        }

        .prayer-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 0.1rem;
            margin-bottom: 1rem;
            line-height: 1.1;
        }

        .prayer-text {
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .prayer-footer {
            margin-top: 2rem;
            text-align: center;
            line-height: 1.6;
        }

        .prayer-translation {
            margin-top: 2rem;
            margin-bottom: 2rem;
            color: #ccc;
            line-height: 1.6;
            padding-left: 1rem;
            border-left: 2px solid rgba(255, 255, 255, 0.2);
        }

        .prayer-note {
            background-color: rgba(255, 255, 255, 0.05);
            border-left: 3px solid rgba(255, 255, 255, 0.2);
            padding: 1.5rem;
            margin-bottom: 2.5rem;
            line-height: 1.6;
        }

        .prayer-instruction {
            font-style: italic;
            color: #999;
            font-size: 0.9rem;
            margin: 0.5rem 0;
        }

        /* Updated Compass Styles */
        .compass-container {
            position: absolute;
            top: 2rem;
            right: 2rem;
            width: 120px; /* Increased from 60px to 120px */
            height: 120px; /* Increased from 60px to 120px */
            z-index: 10;
        }

        .compass {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .compass-direction {
            position: absolute;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            opacity: 0.75;
            pointer-events: none;
            z-index: 2;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .compass-direction.active {
            opacity: 1;
            color: white;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.8), 0 0 10px rgba(255, 255, 255, 0.5);
            font-weight: 700;
            background-color: rgba(30, 30, 30, 0.8);
        }

        .compass-direction.north {
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
        }

        .compass-direction.east {
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
        }

        .compass-direction.south {
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
        }

        .compass-direction.west {
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
        }

        .compass-ring {
            position: absolute;
            width: 70%; /* Reduced to provide more space for labels */
            height: 70%;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1;
        }

        .compass-needle {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transform-origin: center center;
            transition: transform 0.3s ease;
        }

        .compass-needle svg {
            width: 75%;
            height: 75%;
        }

        .hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            opacity: 0;
            pointer-events: none;
            overflow: hidden;
        }

        /* Permission Button (hidden by default for desktop) */
        .permission-button {
            display: none;
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 0.75rem 1.5rem;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Manrope', sans-serif;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .permission-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Prayer Modal Styling */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 1000;
            display: none;
            overflow: auto;
        }

        .modal-content {
            max-width: 550px;
            margin: 2rem auto;
            padding: 2rem;
            position: relative;
            background-color: #000;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Compass Styling */
        .compass-container {
            margin: 2rem auto;
            width: 200px;
            position: relative;
            text-align: center;
        }

        .compass {
            width: 200px;
            height: 200px;
            position: relative;
            margin: 0 auto;
        }

        .compass-ring {
            width: 100%;
            height: 100%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
        }

        .compass-needle {
            width: 90%;
            height: 90%;
            position: absolute;
            top: 5%;
            left: 5%;
            transition: transform 0.3s ease-out;
        }

        .compass-direction {
            position: absolute;
            font-size: 14px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.6);
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 20px;
            transition: color 0.3s;
        }

        .north {
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
        }

        .east {
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }

        .south {
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
        }

        .west {
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
        }

        .compass-direction.active {
            color: #fff;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        .permission-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            padding: 8px 16px;
            display: none;
            z-index: 1000;
        }

        .compass-status {
            text-align: center;
            font-size: 0.8rem;
            margin-top: 0.5rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .accuracy-high {
            color: #4CAF50;
        }

        .accuracy-medium {
            color: #FFC107;
        }

        .accuracy-low {
            color: #FF9800;
        }

        .accuracy-unreliable,
        .accuracy-error {
            color: #F44336;
        }

        .accuracy-calibrating {
            color: #2196F3;
            animation: blink 1s infinite;
        }

        .compass-button {
            display: block;
            margin: 0.5rem auto;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1.5rem;
            }
            
            .prayer-title {
                font-size: 1.5rem;
            }
            
            .prayer-subtitle {
                font-size: 1rem;
            }
            
            .prayer-name {
                font-size: 1.3rem;
            }

            .compass-container {
                top: 1.5rem;
                right: 1.5rem;
                width: 100px; /* Slightly smaller on mobile but still larger than original */
                height: 100px;
            }

            .permission-button {
                display: block;
            }
            
            .compass-direction {
                font-size: 14px;
                width: 20px;
                height: 20px;
            }
            
            .compass-direction.north {
                top: 10px;
            }

            .compass-direction.east {
                right: 10px;
            }

            .compass-direction.south {
                bottom: 10px;
            }

            .compass-direction.west {
                left: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="../home.html" class="back-button">
                <span class="back-arrow">←</span>
            </a>
        </div>
        
        <div class="compass-container">
            <div class="compass">
                <div class="compass-ring"></div>
                <div class="compass-needle" id="compass-needle">
                    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="50" cy="50" r="40" fill="none" stroke="#fff" stroke-width="1"/>
                        <path d="M50 10 L65 50 L50 90 L35 50 Z" fill="rgba(255,255,255,0.7)"/>
                        <circle cx="50" cy="50" r="8" fill="#000" stroke="#fff" stroke-width="1.5"/>
                    </svg>
                </div>
                <div class="compass-direction north" data-direction="north" data-min="315" data-max="45">N</div>
                <div class="compass-direction east" data-direction="east" data-min="45" data-max="135">E</div>
                <div class="compass-direction south" data-direction="south" data-min="135" data-max="225">S</div>
                <div class="compass-direction west" data-direction="west" data-min="225" data-max="315">W</div>
            </div>
            <div class="compass-status">Waiting for compass...</div>
            <button id="calibrate-button" class="compass-button">Calibrate Compass</button>
        </div>
        
        <div class="prayer-header">
            <p class="prayer-subtitle">the one for humble repentance</p>
            <h2 class="prayer-name">char-disha no namaskar</h2>
        </div>

        <div class="prayer-text">
            <p>Az hamā gunāh patet pashemānum; Ashem Vohū 1.</p>
            
            <p>Nemō āonghām asanghāmcha, shōithranāmcha, gayoaoitināmcha, maēthananāmcha, avō-khvarenanāmcha, apāmcha, zemāmcha, urvaranāmcha, anghāoscha zemō, avanghecha ashnō vātahecha ashaonō strām, māonghō hūrō, anaghranām raochanghām khvadhātanām, vispanāmcha spentahe mainyēush dāmanām, ashaonām ashaonināmcha ashahe rathwām.</p>
            
            <p>Ashem Vohū 1.</p>
            
            <p class="prayer-instruction">(Note: To be recited each time, turning to each direction)</p>
            
            <p>Ahmāi raēshcha; Hazangrem; Jasa me avanghe mazda Kerfeh Mozd.</p>
        </div>

        <div class="prayer-translation">
            <p>I repent for all my sins. I humbly bow my head to all the cities, open fields, the earth, the flowing waters, the sky, the trees, the sun, the moon, the stars and to all the people who follow the path of righteousness.</p>
        </div>
    </div>

    <!-- Mobile permission button (only visible on mobile) -->
    <button id="permission-button" class="permission-button">Enable Compass</button>

    <!-- Hidden elements for compass functionality -->
    <div id="hidden-bearing" class="hidden">0°</div>

    <!-- Prayer Detail Modal (hidden by default) -->
    <div id="prayer-modal" class="modal">
        <div class="modal-content">
            <button class="close-button" onclick="closePrayerModal()">×</button>
            
            <div class="prayer-header">
                <p class="prayer-subtitle" id="modal-subtitle"></p>
                <h3 class="prayer-name" id="modal-name"></h3>
            </div>

            <div class="prayer-text" id="modal-text"></div>

            <div class="prayer-translation" id="modal-translation"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // IMPROVED COMPASS FUNCTIONALITY
            initCompass();

            // Prayer Modal Functions remain unchanged
            function openPrayerModal(prayerId) {
                const modal = document.getElementById('prayer-modal');
                
                // Here you would typically load the specific prayer content based on prayerId
                if (prayerId === 'char-disha-no-namaskar') {
                    document.getElementById('modal-subtitle').textContent = 'the one for humble repentance';
                    document.getElementById('modal-name').textContent = 'char-disha no namaskar';
                    document.getElementById('modal-text').innerHTML = '<p>Az hamā gunāh patet pashemānum; Ashem Vohū 1.</p><p>Nemō āonghām asanghāmcha, shōithranāmcha, gayoaoitināmcha, maēthananāmcha, avō-khvarenanāmcha, apāmcha, zemāmcha, urvaranāmcha, anghāoscha zemō, avanghecha ashnō vātahecha ashaonō strām, māonghō hūrō, anaghranām raochanghām khvadhātanām, vispanāmcha spentahe mainyēush dāmanām, ashaonām ashaonināmcha ashahe rathwām.</p><p>Ashem Vohū 1.</p><p class="prayer-instruction">(Note: To be recited each time, turning to each direction)</p>';
                    document.getElementById('modal-translation').innerHTML = '<p>I repent for all my sins. I humbly bow my head to all the cities, open fields, the earth, the flowing waters, the sky, the trees, the sun, the moon, the stars and to all the people who follow the path of righteousness.</p>';
                }
                
                // Show the modal
                modal.style.display = 'block';
            }

            function closePrayerModal() {
                document.getElementById('prayer-modal').style.display = 'none';
            }

            window.onclick = function(event) {
                const modal = document.getElementById('prayer-modal');
                if (event.target == modal) {
                    closePrayerModal();
                }
            }
        });

        // Improved compass implementation
        function initCompass() {
            const compassNeedle = document.getElementById('compass-needle');
            const permissionButton = document.getElementById('permission-button');
            const calibrateButton = document.getElementById('calibrate-button');
            const compassStatus = document.querySelector('.compass-status');
            const directions = document.querySelectorAll('.compass-direction');
            
            // Track if we have a reliable compass reading
            let hasAccurateReading = false;
            let compassErrorCount = 0;
            
            // Compass accuracy states
            const ACCURACY = {
                HIGH: 'high',
                MEDIUM: 'medium',
                LOW: 'low',
                UNRELIABLE: 'unreliable'
            };
            
            // Variables to track readings
            let lastHeading = 0;
            let alphaFilter = new KalmanFilter();
            let accuracyState = ACCURACY.UNRELIABLE;
            
            // Helper function to get compass accuracy
            function getAccuracyLevel(accuracy) {
                if (accuracy !== undefined) {
                    if (accuracy < 15) return ACCURACY.HIGH;
                    if (accuracy < 30) return ACCURACY.MEDIUM;
                    if (accuracy < 60) return ACCURACY.LOW;
                }
                return ACCURACY.UNRELIABLE;
            }
            
            // Process orientation data with filters
            function processCompassHeading(heading, accuracy) {
                // Apply Kalman filter to smooth heading
                const filteredHeading = alphaFilter.filter(heading);
                
                // Update last heading
                lastHeading = filteredHeading;
                
                // Update accuracy state
                accuracyState = getAccuracyLevel(accuracy);
                updateCompassUI(filteredHeading);
                
                // Track if we have reliable readings
                hasAccurateReading = (accuracyState !== ACCURACY.UNRELIABLE);
                
                // Update UI to reflect accuracy
                compassStatus.textContent = `Accuracy: ${accuracyState}`;
                compassStatus.className = `compass-status accuracy-${accuracyState}`;
                
                return filteredHeading;
            }
            
            // Update compass UI
            function updateCompassUI(heading) {
                // Animate smoothly to new heading
                compassNeedle.style.transition = 'transform 0.3s ease-out';
                compassNeedle.style.transform = `rotate(${360 - heading}deg)`;
                
                // Update direction highlights
                updateDirectionHighlight(heading);
            }
            
            // Update the direction highlighting
            function updateDirectionHighlight(heading) {
                // Normalize bearing to 0-360
                heading = (heading + 360) % 360;
                
                // Determine which direction we're facing
                let newDirection = null;
                
                directions.forEach(dir => {
                    const dirName = dir.dataset.direction;
                    const minAngle = parseInt(dir.dataset.min);
                    const maxAngle = parseInt(dir.dataset.max);
                    
                    // Check if bearing is within this direction's range
                    if (minAngle > maxAngle) {
                        // For North which wraps around (315-45)
                        if (heading >= minAngle || heading < maxAngle) {
                            newDirection = dirName;
                        }
                    } else {
                        // For other directions
                        if (heading >= minAngle && heading < maxAngle) {
                            newDirection = dirName;
                        }
                    }
                });
                
                // Update active direction class
                directions.forEach(dir => {
                    if (dir.dataset.direction === newDirection) {
                        dir.classList.add('active');
                    } else {
                        dir.classList.remove('active');
                    }
                });
            }
            
            // Handle device orientation event
            function handleDeviceOrientation(event) {
                let heading = null;
                let accuracy = undefined;
                
                // iOS-specific compass heading
                if (event.webkitCompassHeading) {
                    heading = event.webkitCompassHeading;
                    accuracy = event.webkitCompassAccuracy;
                } 
                // Standard orientation API
                else if (event.absolute && event.alpha !== null) {
                    heading = 360 - event.alpha;
                }
                
                // Only process valid headings
                if (heading !== null) {
                    processCompassHeading(heading, accuracy);
                } else {
                    compassErrorCount++;
                    if (compassErrorCount > 10) {
                        compassStatus.textContent = "Compass not available";
                        compassStatus.className = 'compass-status accuracy-error';
                    }
                }
            }
            
            // Prompt for permission
            function requestCompassPermission() {
                if (typeof DeviceOrientationEvent !== 'undefined' && 
                    typeof DeviceOrientationEvent.requestPermission === 'function') {
                    
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                window.addEventListener('deviceorientation', handleDeviceOrientation);
                                permissionButton.style.display = 'none';
                                
                                // Start a timeout to check if we're actually receiving events
                                setTimeout(() => {
                                    if (!hasAccurateReading && compassErrorCount === 0) {
                                        // We got permission but no readings - likely no compass hardware
                                        compassStatus.textContent = "No compass detected on device";
                                        compassStatus.className = 'compass-status accuracy-error';
                                    }
                                }, 3000);
                            } else {
                                compassStatus.textContent = "Permission denied";
                                compassStatus.className = 'compass-status accuracy-error';
                            }
                        })
                        .catch(error => {
                            console.error("Error requesting device orientation permission:", error);
                            compassStatus.textContent = "Error requesting permission";
                            compassStatus.className = 'compass-status accuracy-error';
                        });
                } else {
                    // For devices that don't need permission
                    window.addEventListener('deviceorientation', handleDeviceOrientation);
                    
                    // Start a timeout to check if we're actually receiving events
                    setTimeout(() => {
                        if (!hasAccurateReading && compassErrorCount === 0) {
                            // No readings after 3 seconds - likely no compass hardware
                            compassStatus.textContent = "No compass detected on device";
                            compassStatus.className = 'compass-status accuracy-error';
                        }
                    }, 3000);
                }
            }
            
            // Calibration function
            function calibrateCompass() {
                compassStatus.textContent = "Calibrating... rotate device in figure-8 pattern";
                compassStatus.className = 'compass-status accuracy-calibrating';
                
                // Reset the filter
                alphaFilter = new KalmanFilter();
                
                // After calibration time
                setTimeout(() => {
                    compassStatus.textContent = "Calibration complete";
                    setTimeout(() => {
                        if (lastHeading) {
                            updateCompassUI(lastHeading);
                        }
                    }, 1000);
                }, 5000);
            }
            
            // Add event listeners
            permissionButton.addEventListener('click', requestCompassPermission);
            calibrateButton.addEventListener('click', calibrateCompass);
            
            // Try to detect if it's a mobile device
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if (isMobile) {
                permissionButton.style.display = 'block';
            } else {
                compassStatus.textContent = "Compass requires mobile device";
                compassStatus.className = 'compass-status accuracy-error';
                
                // Debug function for desktop testing (move mouse to simulate compass)
                function debugWithMouse(e) {
                    const x = e.clientX;
                    const y = e.clientY;
                    
                    // Calculate angle based on mouse position relative to center of screen
                    const centerX = window.innerWidth / 2;
                    const centerY = window.innerHeight / 2;
                    
                    const angle = Math.atan2(y - centerY, x - centerX) * (180 / Math.PI);
                    const heading = (angle + 90 + 360) % 360; // Convert to compass heading
                    
                    processCompassHeading(heading);
                }
                
                document.addEventListener('mousemove', debugWithMouse);
            }
        }
        
        // Implement Kalman filter for smoother readings
        function KalmanFilter() {
            this.Q = 0.01; // Process noise
            this.R = 0.1;  // Measurement noise
            this.x = 0;    // Initial value
            this.P = 1.0;  // Initial uncertainty
            
            this.filter = function(measurement) {
                // Prediction update
                // x = x
                // P = P + Q
                this.P = this.P + this.Q;
                
                // Measurement update
                const K = this.P / (this.P + this.R);
                
                // Handle the discontinuity between 0 and 360 degrees
                let diff = measurement - this.x;
                if (diff > 180) diff -= 360;
                if (diff < -180) diff += 360;
                
                this.x = (this.x + K * diff) % 360;
                if (this.x < 0) this.x += 360;
                
                this.P = (1 - K) * this.P;
                
                return this.x;
            };
        }
    </script>
</body>
</html>